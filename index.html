<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Notes</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Inter Sans-Serif Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; color: #37352F; -webkit-font-smoothing: antialiased; }
        [x-cloak] { display: none !important; }
        .note-row:hover { background-color: #F8FBFF; }
        .input-underline { border-bottom: 1px solid #E1E1E0; transition: border-color 0.2s ease; }
        .input-underline:focus-within { border-bottom: 2px solid #2383E2; }
        textarea:focus, input:focus { outline: none; }

        /* Clean Markdown Rendering */
        .markdown-body h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .markdown-body p { margin-bottom: 0.5rem; line-height: 1.6; }
        .markdown-body strong { font-weight: 700; color: #000; }
        .markdown-body code { background: #F2F2F1; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.85em; }
        
        /* Hashtag Pill Style */
        .hashtag {
            display: inline-block;
            padding: 1px 8px;
            border-radius: 4px;
            font-size: 0.82em;
            font-weight: 600;
            margin-right: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .hashtag:hover { opacity: 0.7; }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-white" x-data="noteApp()" x-init="init()">

    <!-- Visual Confirmation (Toast) -->
    <div x-show="toastVisible" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-4"
         class="toast" x-cloak x-text="toastMessage">
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/10 backdrop-blur-[2px]" x-transition x-cloak>
        <div @click.away="cancelDelete()" class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 border border-gray-100">
            <h3 class="text-lg font-bold mb-2">Delete note?</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">Are you sure you want to permanently delete this note?</p>
            <div class="flex justify-end gap-3">
                <button @click="cancelDelete()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:bg-gray-100 rounded-md">Cancel</button>
                <button @click="confirmDelete()" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-md">Delete</button>
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <header class="max-w-2xl mx-auto px-6 pt-24 pb-4">
        <div class="flex justify-between items-start mb-2">
            <h1 class="text-4xl font-bold tracking-tight">My Notes</h1>
            
            <!-- Search Toggle -->
            <div class="flex items-center">
                <div x-show="searchOpen" x-transition x-cloak class="mr-2">
                    <input type="text" x-model="searchQuery" placeholder="Search notes or #tags..." 
                           class="text-sm bg-gray-50 border border-gray-200 px-3 py-1 rounded-md w-48 focus:border-blue-400">
                </div>
                <button @click="toggleSearch()" class="p-2 hover:bg-gray-100 rounded-md text-gray-400 hover:text-gray-600 transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
            </div>
        </div>

        <!-- Meta / Filter Info -->
        <div class="flex items-center gap-2 h-8">
            <template x-if="activeFilter">
                <div class="flex items-center gap-2 bg-blue-50 text-[#2383E2] px-2 py-1 rounded border border-blue-100 text-xs font-semibold">
                    <span>Filter: <span x-text="activeFilter"></span></span>
                    <button @click="activeFilter = null" class="hover:bg-blue-100 rounded p-0.5">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </template>
            <template x-if="!activeFilter && !searchQuery">
                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest" x-text="notes.length + ' entries'"></div>
            </template>
            <button x-show="activeFilter || searchQuery" @click="clearAllFilters()" class="text-[10px] font-bold text-gray-400 hover:text-gray-600 uppercase tracking-widest">Show all</button>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-6 pb-40">
        <!-- New Note Input (Enter to save, Shift+Enter for newline) -->
        <div class="mb-16 group">
            <div class="input-underline py-2">
                <textarea x-model="newNoteContent" 
                    @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); addNote(); }"
                    placeholder="Type something..." 
                    class="w-full text-lg leading-relaxed bg-transparent border-none p-0 resize-none h-auto overflow-hidden placeholder-gray-300"
                    rows="1" @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"></textarea>
            </div>
            <div x-show="newNoteContent.trim().length > 0" x-cloak class="mt-3 flex justify-between items-center">
                <button @click="addNote()" class="text-xs font-bold text-[#2383E2] uppercase tracking-wider">Save Note</button>
                <span class="text-[10px] text-gray-400 font-medium">Return to save â€¢ Shift+Return for newline</span>
            </div>
        </div>

        <!-- Long Page Note Stream -->
        <div class="space-y-1">
            <template x-for="note in filteredNotes" :key="note.id">
                <div class="note-row group relative -mx-4 px-4 py-6 rounded-lg transition-all duration-200">
                    <div class="flex items-baseline gap-6">
                        <!-- Date/Time Sidebar -->
                        <div class="w-24 flex-shrink-0 pt-1">
                            <span class="text-[10px] font-bold text-gray-300 uppercase whitespace-nowrap" x-text="note.timestamp"></span>
                        </div>

                        <!-- Content Area -->
                        <div class="flex-grow pr-16">
                            <div x-show="editingId !== note.id">
                                <!-- Note Text (Hashtags hidden from body) -->
                                <div class="markdown-body text-[15px]" x-html="renderCleanContent(note.content)"></div>
                                
                                <!-- Color-coded Hashtags below note -->
                                <div class="mt-4 flex flex-wrap gap-1" x-show="extractTags(note.content).length > 0">
                                    <template x-for="tag in extractTags(note.content)">
                                        <span @click="activeFilter = tag" :class="getTagStyle(tag)" class="hashtag" x-text="tag"></span>
                                    </template>
                                </div>
                            </div>

                            <!-- Inline Editing -->
                            <div x-show="editingId === note.id" x-cloak>
                                <textarea x-model="editValue" @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); saveEdit(note.id); }"
                                    class="w-full text-[15px] bg-white border border-blue-100 p-3 rounded-md shadow-sm outline-none ring-2 ring-blue-50" rows="3"
                                    x-init="$watch('editingId', v => v === note.id && $nextTick(() => $el.focus()))"></textarea>
                                <div class="mt-2 flex gap-4">
                                    <button @click="saveEdit(note.id)" class="text-[11px] font-bold text-blue-600 uppercase">Update</button>
                                    <button @click="editingId = null" class="text-[11px] font-bold text-gray-400 uppercase">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions (Hover visible) -->
                        <div class="absolute right-4 top-6 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <!-- Gmail -->
                            <button @click="shareGmail(note)" title="Send via Gmail" class="text-gray-300 hover:text-blue-500 p-1">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                            </button>
                            <!-- Copy to Clipboard -->
                            <button @click="copyToClipboard(note.content)" title="Copy text" class="text-gray-300 hover:text-gray-700 p-1">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                            </button>
                            <!-- Edit -->
                            <button @click="startEdit(note)" title="Edit" class="text-gray-300 hover:text-blue-500 p-1">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <!-- Delete -->
                            <button @click="promptDelete(note.id)" title="Delete" class="text-gray-300 hover:text-red-500 p-1">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <script>
        function noteApp() {
            return {
                notes: [],
                searchOpen: false,
                searchQuery: '',
                activeFilter: null,
                newNoteContent: '',
                editingId: null,
                editValue: '',
                showDeleteModal: false,
                noteIdToDelete: null,
                toastVisible: false,
                toastMessage: '',
                tagColors: ['bg-red-100 text-red-800', 'bg-blue-100 text-blue-800', 'bg-green-100 text-green-800', 'bg-amber-100 text-amber-800', 'bg-purple-100 text-purple-800', 'bg-rose-100 text-rose-800', 'bg-indigo-100 text-indigo-800', 'bg-emerald-100 text-emerald-800', 'bg-orange-100 text-orange-800', 'bg-cyan-100 text-cyan-800'],

                init() {
                    this.notes = JSON.parse(localStorage.getItem('notes_v15_clipboard') || '[]');
                    marked.setOptions({ breaks: true, gfm: true });
                },

                persist() { localStorage.setItem('notes_v15_clipboard', JSON.stringify(this.notes)); },

                get filteredNotes() {
                    let items = this.notes;
                    if (this.activeFilter) items = items.filter(n => this.extractTags(n.content).includes(this.activeFilter));
                    if (this.searchQuery) items = items.filter(n => n.content.toLowerCase().includes(this.searchQuery.toLowerCase()));
                    return items;
                },

                getTagStyle(tag) {
                    let hash = 0;
                    for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash);
                    return this.tagColors[Math.abs(hash) % this.tagColors.length];
                },

                extractTags(content) {
                    const matches = content.match(/(^|\s)#(\w+)/g);
                    if (!matches) return [];
                    return [...new Set(matches.map(t => t.trim().toLowerCase()))];
                },

                renderCleanContent(content) {
                    // Strips hashtags from body text for visual display only
                    let cleaned = content.replace(/(^|\s)#\w+/g, ' ').replace(/\s+/g, ' ').trim();
                    return marked.parse(cleaned || content);
                },

                addNote() {
                    if (!this.newNoteContent.trim()) return;
                    const now = new Date();
                    const timestamp = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    this.notes.unshift({ id: Date.now(), content: this.newNoteContent, timestamp: timestamp });
                    this.newNoteContent = '';
                    this.persist();
                },

                // RELIABLE COPY FUNCTION
                async copyToClipboard(text) {
                    try {
                        // Attempt modern Clipboard API
                        if (navigator.clipboard && window.isSecureContext) {
                            await navigator.clipboard.writeText(text);
                        } else {
                            // Fallback to execCommand('copy')
                            let textArea = document.createElement("textarea");
                            textArea.value = text;
                            textArea.style.position = "fixed";
                            textArea.style.left = "-9999px";
                            textArea.style.top = "0";
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            document.execCommand('copy');
                            textArea.remove();
                        }
                        this.showToast("Note text copied to clipboard");
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                    }
                },

                showToast(msg) {
                    this.toastMessage = msg;
                    this.toastVisible = true;
                    setTimeout(() => { this.toastVisible = false; }, 2500);
                },

                shareGmail(note) {
                    const recipient = "target@email.com";
                    const subjectText = note.content.substring(0, 100).replace(/(^|\s)#\w+/g, '').trim();
                    const subject = encodeURIComponent(subjectText || "Note Export");
                    const body = encodeURIComponent(`Timestamp: ${note.timestamp}\n\n${note.content}`);
                    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${recipient}&su=${subject}&body=${body}`;
                    window.open(gmailUrl, '_blank');
                },

                toggleSearch() {
                    this.searchOpen = !this.searchOpen;
                    if(this.searchOpen) setTimeout(() => document.querySelector('input').focus(), 100);
                },

                clearAllFilters() {
                    this.activeFilter = null;
                    this.searchQuery = '';
                },

                promptDelete(id) { this.noteIdToDelete = id; this.showDeleteModal = true; },
                cancelDelete() { this.showDeleteModal = false; this.noteIdToDelete = null; },
                confirmDelete() { this.notes = this.notes.filter(n => n.id !== this.noteIdToDelete); this.persist(); this.cancelDelete(); },
                startEdit(note) { this.editingId = note.id; this.editValue = note.content; },
                saveEdit(id) {
                    const idx = this.notes.findIndex(n => n.id === id);
                    if (idx !== -1) { this.notes[idx].content = this.editValue; this.editingId = null; this.persist(); }
                }
            }
        }
    </script>
</body>
</html>
